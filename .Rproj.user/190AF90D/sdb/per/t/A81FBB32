{
    "collab_server" : "",
    "contents" : "---\ntitle: widened statistical analysis for the cofactors paper\n---\n\n```{r set_knitr_chunk_options,echo=FALSE,message=FALSE,warning=FALSE}\n#bibliography: references.bib\n\nrequire(knitr)\nrequire(kfigr)\nrequire(magrittr)\nopts_chunk$set(echo=FALSE,message=FALSE,warning=F,cache = F)#,eval.after='fig.height') # important for making sure the output will be well formatted.\noptions(scipen=9999)\n\n#### Citations\nrequire(bibtex)\nrequire(knitcitations)\nbiblio <- read.bib(\"bib.bibtex\")\ncite_options(citation_format = \"compatibility\", style = \"text\",\n             hyperlink = FALSE, cite.style = \"numeric\", super = FALSE,\n             max.names = 4, longnamesfirst = FALSE, check.entries = FALSE)\n\nrequire(pander)\n#replace.print.methods <- function(PKG_name = \"pander\") {\n#   PKG_methods <- as.character(methods(PKG_name))\n#   print_methods <- gsub(PKG_name, \"print\", PKG_methods)\n#   for(i in seq_along(PKG_methods)) {\n#      f <- eval(parse(text=paste(PKG_name,\":::\", PKG_methods[i], sep = \"\"))) # the new function to use for print\n#      assign(print_methods[i], f, \".GlobalEnv\")\n#   }\n#}\n#replace.print.methods()\n## The following might work with some tweaks:\n## print <- function (x, ...) UseMethod(\"pander\")\n\npanderOptions('table.split.table',Inf)\n\n# Here I read data into R using the function below and save it in a native R format. \n# data <- read.spss(\"/home/wojtek/Documents/anaphylaxis registry/anaphylaxis/anaphylaxis_registry_02_mar_2015_mergedSD.sav\",use.value.labels = TRUE,to.data.frame = T,trim.factor.names = T,trim_values = T) #this loads the databbase from spss file - watch out for errors.\n\n# new database!!!!\n# data <- read.spss(\"/home/wojtek/Documents/anaphylaxis registry/anaphylaxis/anaphylaxis_registry_18_apr_2016_mergedSD.sav\",use.value.labels = TRUE,to.data.frame = T,trim.factor.names = T,trim_values = T) #this loads the databbase from spss file - watch out for errors.\n\n# new database 2017 !!!!\n# library(\"foreign\")\n# data3 <- read.spss(\"/home/wolass/Documents/anaphylaxis/anaphylaxis_registry_20_mar_2017_mergedSD.sav\",use.value.labels = TRUE,to.data.frame = T,trim.factor.names = T,trim_values = T) #this loads the databbase from spss file - watch out for errors.\n\n# save(data3,file = \"data3.R\") # dor database from 2015 choose data.R\nload(\"data3.R\")\n# load(\"data2.R\")\ndata <- data3[,-16]\n# I could make a nice table showing  mistakes in our database. \n# length(which(data$q_111==\"no\"&data$q_111_angioedema==\"unknown\"))\n\n### Here I will introduce functions for database conformity\nfor(i in c(16:55,65,75,178:205,209:220,222:223)){\n  levels(data[,i]) <- c(levels(data[,i])[1:2],NA)  \n}\nfor(i in c(79:83)){\n  levels(data[,i]) <- c(levels(data[,i])[1:2],\"no\")  \n}\nlevels(data$q_421_exercise) <- c(\"no\",\"mild\",\"moderate\",\"vigorous\",NA)\n\nno.of.centers <- length(levels(data$b_centres_id))\nno.of.countries <- length(summary(data$d_centres_country)) - length(which(summary(data$d_centres_country)==0))\n\nno.of.cases <- length(data$b_case_id)\nno.of.patients <- no.of.cases - (length(which(summary(data$b_patient_code)==2)) + length(which(summary(data$b_patient_code)==3)) +length(which(summary(data$b_patient_code)==4)) + length(which(summary(data$b_patient_code)==5)))\n\nno.of.F <- summary(data$b_sex)[1]\nno.of.M <- summary(data$b_sex)[2]\n\n#Check this using the following line\n#summary(as.factor(summary(data$b_patient_code)))\n\n\n#here creating the brown outcome variable\nbrown <- rep(\"mild-moderate\",length(data[,1]))\nbrown[which(data$q_112_incontinence==\"yes\"|data$q_114_loss_of_consciousness==\"yes\"|data$q_114_hypotension_collapse_v5==\"yes\"|data$q_112_incontinence==\"yes\"|data$q_115_cyanosis_pallor_v6==\"yes\"|data$q_114_reductions_of_alertness==\"yes\")] <- \"severe\"\ndata$brown <- as.factor(brown)\n\n#MAKING ANAScore3\n#is done with the function make.anascore from my anareg package\nrequire(anareg)\n#ANAscore3 <- make.anascore(symptoms=c(17:21,23:29,31:39,41:55,65),weights=c(3,2,1,2,2,3,1,4,3,4,12,3,8,4,1,20,4,2,8,8,1,20,18,20,10,6,18,12,10,18,2,8,3,15,20,6,50),grades=c(1,1,1,1,1,1,1,2,1,2,3,1,2,2,1,4,2,1,2,2,1,4,3,4,2,2,3,3,2,3,1,2,1,3,4,2,5),data=data)\n\n#data <- data.frame(data,ANAscore3)\n\n\n### Making ANASCORE 4 - the second version of it which I did on the 8.04.2016 the copied and commented was the original 4.\nA <- names(data)[c(33,39,36,21,18,19,50,20)]\nB <- names(data)[c(35,38,37,31,32,55)]\nC <- names(data)[c(26,23,29,24,27,25,28)]\nD <- names(data)[c(17,45,47,48,42,41,34,43)]\nE <- names(data)[c(44,52,51,53,46,49)]\nG <- names(data)[c(54,65)]\n\nANAscore4 <- rep(0, length(data[,1])\n                 )\n\nA.db<-rep(0,length(data[,1]))\nfor(i in 1:length(A)){\n  A.db<- data.frame(A.db,sapply(data[,A[i]],function(x){ifelse(x==\"yes\",i,0)}))\n}\n\nA.s <-apply(A.db,1,max,na.rm=T)\n\nB.db<-rep(0,length(data[,1]))\nfor(i in 1:length(B)){\n  B.db<- data.frame(B.db,sapply(data[,B[i]],function(x){ifelse(x==\"yes\",i,0)}))\n}\n\nB.s <-apply(B.db,1,max,na.rm=T)\n\nC.db<-rep(0,length(data[,1]))\nfor(i in 1:length(C)){\n  C.db<- data.frame(C.db,sapply(data[,C[i]],function(x){ifelse(x==\"yes\",(i*3)-2,0)}))\n}\n\nC.s <-apply(C.db,1,max,na.rm=T)\n\nD.db<-rep(0,length(data[,1]))\nfor(i in 1:length(D)){\n  D.db<- data.frame(D.db,sapply(data[,D[i]],function(x){ifelse(x==\"yes\",i,0)}))\n}\n\nD.s <-apply(D.db,1,max,na.rm=T)\n\nE.db<-rep(0,length(data[,1]))\nfor(i in 1:length(E)){\n  E.db<- data.frame(E.db,sapply(data[,E[i]],function(x){ifelse(x==\"yes\",i,0)}))\n}\nE.s <-apply(E.db,1,max,na.rm=T)\n\nG.db <- rep(0,length(data[,1]))\nfor(i in 1:length(G)){\n  G.db<- data.frame(G.db,sapply(data[,G[i]],function(x){ifelse(x==\"yes\",i,0)}))\n}\nG.s<-apply(G.db,1,max,na.rm=T)\n\n# plot(A.s+(B.s*2)+C.s+(D.s*3)+(E.s*3)+(G.s*30)~data$d_severity_rm)\nANAscore4 <- A.s+(B.s*2)+C.s+(D.s*5)+(E.s*3)+(G.s*25)\nANAscore4 <- apply(data.frame(A.s,(B.s*2),C.s,(D.s*5),(E.s*3),(G.s*25)),1,max,na.rm=T)\ndata$ANAscore4 <-ANAscore4\n# ggplot(data,aes(d_severity_rm,ANAscore4,color=q_114_cardiac_arrest))+\n  # geom_point(position=position_jitter(width=0.5),alpha=0.3)\n# A <- names(data)[c(33,39,36,21,18,19,50,20)]\n# B <- names(data)[c(35,38,37,31,32,55)]\n# C <- names(data)[c(26,23,29,24,27,25,28)]\n# D<-names(data)[c(17,45,47,42)]\n# E <- names(data)[c(44,52,51,53,46,49,48)]\n# Fa <-names(data)[c(41,34,43)]\n# G <- names(data)[54]\n# H <- names(data)[65]\n# \n# ANAscore4 <- rep(0, length(data[,1]))\n# #sapply(data[,A[1]],function(x){ifelse(x==\"yes\",1,0)})\n# \n# # A.db <-sapply(data[,A],function(y){sapply(y,function(x){ifelse(x==\"yes\",1,0)})})\n# \n# A.db<-rep(0,length(data[,1]))\n# for(i in 1:length(A)){\n#   A.db<- data.frame(A.db,sapply(data[,A[i]],function(x){ifelse(x==\"yes\",i,0)}))\n# }\n# \n# A.s <-apply(A.db,1,max,na.rm=T)\n# \n# B.db<-rep(0,length(data[,1]))\n# for(i in 1:length(B)){\n#   B.db<- data.frame(B.db,sapply(data[,B[i]],function(x){ifelse(x==\"yes\",i,0)}))\n# }\n# \n# B.s <-apply(B.db,1,max,na.rm=T)\n# \n# C.db<-rep(0,length(data[,1]))\n# for(i in 1:length(C)){\n#   C.db<- data.frame(C.db,sapply(data[,C[i]],function(x){ifelse(x==\"yes\",i,0)}))\n# }\n# \n# C.s <-apply(C.db,1,max,na.rm=T)\n# \n# D.db<-rep(0,length(data[,1]))\n# for(i in 1:length(D)){\n#   D.db<- data.frame(D.db,sapply(data[,D[i]],function(x){ifelse(x==\"yes\",i,0)}))\n# }\n# \n# D.s <-apply(D.db,1,max,na.rm=T)\n# \n# E.db<-rep(0,length(data[,1]))\n# for(i in 1:length(E)){\n#   E.db<- data.frame(E.db,sapply(data[,E[i]],function(x){ifelse(x==\"yes\",i,0)}))\n# }\n# \n# E.s <-apply(E.db,1,max,na.rm=T)\n# \n# Fa.db<-rep(0,length(data[,1]))\n# for(i in 1:length(Fa)){\n#   Fa.db<- data.frame(Fa.db,sapply(data[,Fa[i]],function(x){ifelse(x==\"yes\",i*2+24,0)}))\n# }\n# \n# Fa.s <-apply(Fa.db,1,max,na.rm=T)\n# \n# G.s <- rep(0,length(data[,1]))\n# G.s[data[,G]==\"yes\"] <- 10\n# H.s <- rep(0,length(data[,1]))\n# H.s[data[,H]==\"yes\"] <- 30\n# \n# #plot(A.s+(B.s*2)+C.s+(D.s*5)+(E.s*3)+(Fa.s*10)+G.s+H.s~data$d_severity_rm)\n# ANAscore4 <- A.s+(B.s*2)+C.s+(D.s*5)+(E.s*3)+Fa.s+G.s+H.s\n# data$ANAscore4 <-ANAscore4\n\nANAscore5 <- rep(0,length(data[1,]))\nA <- names(data)[c(39,21,18,19,20)]\nB <- names(data)[c(33,50,26,36)]\nC <- names(data)[c(23,29,24)]\nC1 <- names(data)[c(44)]\nC2 <- names(data)[c(17)]\nC3 <- names(data)[c(51,53)]\nC4 <- names(data)[c(35,38,37)]\nC5 <- names(data)[c(52)]\nC6 <- names(data)[c(45,47)]\nC8 <- names(data)[c(48,32)]\nC9 <- names(data)[c(25,27)]\nC10 <- names(data)[c(31)]\nC11 <- names(data)[c(42)]\nC12 <- names(data)[c(54)]\nC13 <- names(data)[c(46,49)]\nC14 <- names(data)[c(41)]\nC15 <- names(data)[c(28)]\nC16 <- names(data)[c(55)]\nC18 <- names(data)[c(34,43)]\nC19 <- names(data)[c(65)]\n\n\nAs <- c(A,B,C,C1,C2,C3,C4,C5,C6,C8,C9,C10,C11,C12,C13,C14,C15,C16,C18,C19)\ntemp <- sapply(data[,As],function(x){\n  ifelse(x==\"yes\",1,0) \n})\n\nA.s <-apply(temp[,A],1,max,na.rm=T)\nB.s <- apply(temp[,B]*2,1,max,na.rm=T)\nC.s <- apply(temp[,C]*3,1,max,na.rm=T)\nC1.s <- temp[,C1]*4\nC2.s <- temp[,C2]*5\nC3.s <- apply(temp[,C3]*6,1,max,na.rm=T)\nC4.s <- apply(temp[,C4]*7,1,max,na.rm=T)\nC5.s <- temp[,C5]*8\nC6.s <- apply(temp[,C6]*9,1,max,na.rm=T)\nC8.s <- apply(temp[,C8]*10,1,max,na.rm=T)\nC9.s <- apply(temp[,C9]*11,1,max,na.rm=T)\nC10.s <- temp[,C10]*12\nC11.s <- temp[,C11]*13\nC12.s <- temp[,C12]*14\nC13.s <- apply(temp[,C13]*15,1,max,na.rm=T)\nC14.s <- temp[,C14]*16\nC15.s <- temp[,C15]*17\nC16.s <- temp[,C16]*18\nC18.s <- apply(temp[,C18]*19,1,max,na.rm=T)\nC19.s <- temp[,C19]*20\n\nANAscore5 <- apply(data.frame(A.s,B.s,C.s,C1.s,C2.s,C3.s,C4.s,C5.s,C6.s,C8.s,C9.s,C10.s,C11.s,C12.s,C13.s,C14.s,C15.s,C16.s,C18.s,C19.s),1,max,na.rm=T)\n\n\n# plot(A.s+(B.s*2)+C.s+(D.s*3)+(E.s*3)+(G.s*30)~data$d_severity_rm)\ndata$ANAscore4 <-ANAscore5\n# ggplot(data,aes(d_severity_rm,ANAscore4,color=q_114_cardiac_arrest))+\n  # geom_point(position=position_jitter(width=0.5),alpha=0.3)\n\n\n# if \n### Predictors: MOR month of reaction and MOB moth of birth\n\nDOB <- as.POSIXlt(data$b_date_of_birth,origin=\"1582-10-14\")\n#DOR <- as.POSIXlt(data$b_reactiondate,origin=\"1582-10-14\")\nlibrary(zoo)\nMOB <- format(as.yearmon(DOB), \"%m\")\n#byly problemy z reaction date - bo nie byla poprawna czesto data\n\n#d_reactiondate <-gsub(\".NA\",\".2009\",data$b_reactiondate)\nd_reactiondate <-gsub(\"00.\",\"01.\",gsub(\".00.\",\".NA.\",data$b_reactiondate))\nMOR <- as.factor(format(as.yearmon(as.Date(d_reactiondate,format=\"%d.%m.%Y\")),\"%m\"))\ndata$MOR <- MOR\n\n# Create function for presenting multiple plots\nmultiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {\n  library(grid)\n  \n  # Make a list from the ... arguments and plotlist\n  plots <- c(list(...), plotlist)\n  \n  numPlots = length(plots)\n  \n  # If layout is NULL, then use 'cols' to determine layout\n  if (is.null(layout)) {\n    # Make the panel\n    # ncol: Number of columns of plots\n    # nrow: Number of rows needed, calculated from # of cols\n    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),\n                     ncol = cols, nrow = ceiling(numPlots/cols))\n  }\n  \n  if (numPlots==1) {\n    print(plots[[1]])\n    \n  } else {\n    # Set up the page\n    grid.newpage()\n    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))\n    \n    # Make each plot, in the correct location\n    for (i in 1:numPlots) {\n      # Get the i,j matrix positions of the regions that contain this subplot\n      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))\n      \n      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,\n                                      layout.pos.col = matchidx$col))\n    }\n  }\n}\n\n# Define a new variable - reaction type\n# reaction_type_brown <- rep(NA, length(data[1])) \n# reaction_type_brown[which(data$d_organ_sum==\"one\"&data$q_111==\"yes\")] <- \"skin only\"\n# reaction_type_brown[which(data$q_111==\"yes\"&(data$q_112==\"yes\"|data$q_113==\"yes\"|data$q_114==\"yes\"))] <- \"anaphylaxis\"\n# \n# reaction_type_brown[which(data$q_120_time_between_v4%in%c(\"00 – 10 Minutes\",\"11 - 30 Minutes\",\"31 - 60 Minutes\",\"61 - 120 Minutes\")&data$d_organ_sum%in%c(\"two\",\"three\",\"four\"))] <- \"anaphylaxis\"\n# reaction_type <- as.factor(reaction_type)\n# summary(reaction_type)\n\n\nsentinel_skin <- rep(F, nrow(data))\nsentinel_skin[which(data$q_111_angioedema==\"yes\"|\n                      data$q_111_urticaria==\"yes\"|\n                      data$q_111_erythema_flush_v5==\"yes\"|\n                      data$q_111_pruritus==\"yes\")] <- T\n\nsentinel_respiratory <- rep(F, nrow(data))\nsentinel_respiratory[which(data$q_115_cyanosis_pallor_v6==\"yes\"|\n                             data$q_113_stridor_inspiratory==\"yes\"|\n                             data$q_113_wheezing_expiratory_distress_v5==\"yes\"|\n                             data$q_113_dyspnea==\"yes\"|\n                             data$q_113_respiratory_arrest==\"yes\")] <- T\n\nsentinel_cardio <- rep(F, nrow(data))\nsentinel_cardio[which(\n  data$q_112_incontinence==\"yes\"|\n    data$q_114_reductions_of_alertness==\"yes\"|\n    data$q_114_loss_of_consciousness==\"yes\"|\n    data$q_114_cardiac_arrest==\"yes\"|\n    data$q_114_hypotension_collapse_v5==\"yes\")] <- T\n\nsentinel_gastro <- rep(F, nrow(data))\nsentinel_gastro[which(data$q_112_abdominal_pain==\"yes\"|\n                        data$q_112_vomiting==\"yes\")] <- T\n\nreaction_type_brown <- rep(NA, length(data[,1]))\n# reaction_type_brown[which(data$d_organ_sum==\"one\"&data$q_111==\"yes\")] <- \"skin only\"\n\n# Correct the sum of organs involved.\norgan_sum <- rep(0,nrow(data))\norgan_sum <- organ_sum+ ifelse(!is.na(data[,16]),\n                               ifelse(data[,16]==\"yes\",1,0),\n                               0)\norgan_sum <- organ_sum+ ifelse(!is.na(data[,22]),\n                               ifelse(data[,22]==\"yes\",1,0),\n                               0)\norgan_sum <- organ_sum+ ifelse(!is.na(data[,30]),\n                               ifelse(data[,30]==\"yes\",1,0),\n                               0)\norgan_sum <- organ_sum+ ifelse(!is.na(data[,40]),\n                               ifelse(data[,40]==\"yes\",1,0),\n                               0)\n\norgan_sum %<>% factor()\n\n\nreaction_type_brown[which(organ_sum==\"1\"&data$d_111_sum%in%\n                            c(\"one\",\"two\",\"three\",\"four\",\"five\"))] <- \"skin only\"\n\nreaction_type_brown[which(sentinel_skin==T&(sentinel_cardio==T|sentinel_respiratory==T))] <- \"anaphylaxis\"\n\ndata$q_120_time_between_v4 <- factor(data$q_120_time_between_v4,labels=c(\"NA\",\"unknown\",\"10\",\"30\",\"60\",\"120\",\"4h\",\"more\",\"4h\"))\n\n# BELOW: I am not including the information about the time from exposure to reaction as it was largly missing. The cases are nevertheless supposed allergic reactions therefore the likelyhood of an allergen and occurence of these symptoms should be strict enough to be sufficient as a definition of anaphylaxis.\n\n\nreaction_type_brown[which(#data$q_120_time_between_v4%in%levels(data$q_120_time_between_v4)[3:7]&\n  ((sentinel_skin==T&sentinel_cardio==T)|\n     (sentinel_skin==T&sentinel_gastro==T)|\n     (sentinel_skin==T&sentinel_respiratory==T)|\n     (sentinel_cardio==T&sentinel_gastro==T)|\n     (sentinel_cardio==T&sentinel_respiratory==T)|\n     (sentinel_respiratory==T&sentinel_gastro==T)))] <- \"anaphylaxis\"\nreaction_type_brown[is.na(reaction_type_brown)] <-\"ANA-def not met\"\n\nreaction_type_brown <- as.factor(reaction_type_brown)\ndata$reaction_type_brown <- reaction_type_brown\n\n# Add severity of anaphylaxis\nseverity_brown <- rep(NA,length(data[,1]))\nseverity_brown[which(reaction_type_brown==\"anaphylaxis\")]<-\"mild\"\nseverity_brown[which(reaction_type_brown==\"anaphylaxis\"&(data$q_115_cyanosis_pallor_v6==\"yes\"|data$q_114_hypotension_collapse_v5==\"yes\"|data$q_114_loss_of_consciousness==\"yes\"|data$q_114_reductions_of_alertness==\"yes\"|data$q_112_incontinence==\"yes\"))] <- \"severe\"\nseverity_brown <- as.factor(severity_brown)\ndata$severity_brown <- severity_brown\ndef <- summary(reaction_type_brown[unique(data$b_patient_code)])\n\n# create the agegroup variable\nage_group <- rep(NA,length(data[,1]))\nage_group[data$d_age<13] <- \"child\"\nage_group[which(data$d_age>12 & data$d_age<57)] <- \"adult\"\nage_group[data$d_age>56] <- \"senior\"\ndata$age_group<-factor(age_group,levels = c(\"child\",\"adult\",\"senior\"))\n# summary(data$age_group)\n\n\n#Correcting ELICITORS\n# data$d_elicitor_group <- relevel(data$d_elicitor_group,ref=\"others\")\n#Cold\n# sapply(data[,113:177],function(x){x[grep(\"col\",x)]})\n\n# Check for elicitors using this formula\n# data$q_380_cold_v6[which(data$q_390_other_free==\"Kälte                                                                                               \")] <- \"yes\"\n\n#This is the initial set of predictors\nini.pred <- c('d_age','b_sex','q_410_rhinitis_cur','q_410_asthma_cur','q_410_ad_cur','q_410_cardio_cur','q_410_masto_cur','q_410_thyroid_cur','q_421_exercise','q_422_stress','q_423_ace','q_423_asa','q_423_at2','q_423_beta','q_423_other',\"d_elicitor_group\",\"q_160_ever_react\",\"q_425_alcohol\")\n\n## MAke this for the whole database\nlevels(data$d_elicitor_group)<- c(\"unknown\",\"food\",\"drug\",\"insects\",\"other\",\"other\",\"other\",\"other\",\"other\",\"other\")\ndata$d_elicitor_group <- relevel(data$d_elicitor_group,ref=\"other\")\n```\n\n```{r elicitor_summary}\ntable(data3$d_elicitor_group,data$d_elicitor_group)\n```\n\nABOVE we see the exact consistency of OTHER elicitors.\n\nWe have 620 cases of IDIOPATHIC ANAPHYLAXIS: `r summary(data$d_elicitor_group)[2]`.\n\nThese are going to be rmoved from the main model and we are going to look into them closely later\n\n\n```{r}\n# use plyr count fu\ndata$q_390_other_free[grep(\"nisak\",data$q_390_other_free)] <- plyr::count(data$q_390_other_free)[19,1]\n# count(data$q_390_other_free)\n\n\n#OUTCOMES\ndata$rmr <- data$d_severity_rm\nlevels(data$rmr)<-c(\"I+II\",\"I+II\",\"III+IV\",\"III+IV\")\ndata$rmr2 <- data$d_severity_rm\nlevels(data$rmr2)<-c(\"I+II+III\",\"I+II+III\",\"I+II+III\",\"IV\")\n\n\n\n# All previous models of this regression are in this file \n\nrequire(anareg)\npredictors <- c(names(data[,c(11,12,181,183,185,189,195,197,208,209,211:214,220)]),\"d_elicitor_group\",\"q_160_ever_react\",\"q_425_alcohol\")\ndata.r <- data[which(reaction_type_brown==\"anaphylaxis\"),]\ndata.c <- cc.restrictor(\"severity_brown\",predictors,data.r,single.set = T)\n\n#For RMR\ndata.c.rmr <- cc.restrictor(\"rmr\",predictors,data.r,single.set = T)\ndata.c.rmr2 <- cc.restrictor(\"rmr2\",predictors,data.r,single.set = T)\n\n\n# delate after puting the functions into anareg package\n\n# Multiple plot function\n#\n# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)\n# - cols:   Number of columns in layout\n# - layout: A matrix specifying the layout. If present, 'cols' is ignored.\n#\n# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),\n# then plot 1 will go in the upper left, 2 will go in the upper right, and\n# 3 will go all the way across the bottom.\n#\n\n\nprzekladaniec <- function(names){\n  names <- names(names)\n  a<-NULL\n  c <- sapply(names,function(x){\n    a<- c(a,paste0(x,\":no\"))\n    a<- c(a,paste0(x,\":yes\"))\n    return(a)\n  })\n  return(as.vector(c))\n}\n\nrel.mats <-function(groupings,outcome){\n  x <- lapply(groupings,FUN=function(x){rel.mat(x,outcome)})\n  x2 <- data.frame(matrix(unlist(x),nrow=4))\n  row.names(x2) <- row.names(x[[1]])\n  names(x2) <-przekladaniec(groupings)\n  return(as.matrix(x2))\n}\n\nrel.mat <- function(grouping,outcome){\n  l.g <- levels(grouping)\n  l.o <- levels(outcome) \n  no <- sapply(l.o,function(x){\n    length(which(outcome[grouping==l.g[1]]==x))\n  })\n  \n  yes <- sapply(l.o,function(x){\n    length(which(outcome[grouping==l.g[2]]==x))\n  })\n  s.n <- no/sum(no)\n  s.y <- yes/sum(yes) \n  \n  x <- data.frame(s.n[order(4:1)],s.y[order(4:1)])\n  names(x) <- c(l.g[1],l.g[2])\n  \n  return(x)\n}\n\nrel.heatmap <- function(x){\n  lmat <- rbind( c(0,3,0), c(2,1,4) )\n  lhei <- c(0.1, 1)\n  lwid <- c(0.1, 1,0.1)\n  heatmap.2(as.matrix(x),dendrogram = \"none\",key=F,col=colorRampPalette(c(\"white\", \"black\"))(50), reorderfun =function(x){x},Rowv=F,Colv=F,lhei=lhei,lwid=lwid,lmat=lmat,margins=c(13,3),scale=\"none\",trace='none',distfun=function(x){x},colsep=seq(2, ncol(x),by=2), sepcolor=\"cyan\")\n}\n\n\n# Missing values in predictors variables\n\nsums.preds <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],summary)\nsums.preds.t <- do.call(rbind,sums.preds)\nsums.preds.t.9  <- summary(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(9)]])\nsums.preds.t.16 <- summary(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(16)]])\n\n\nsums.preds.B <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],function(x){\n  table(x,data[which(reaction_type_brown==\"anaphylaxis\"),\"severity_brown\"])\n})\nsums.preds.b <- do.call(rbind,sums.preds.B)\n\n\nsums.preds.RM <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],function(x){\n  table(x,data[which(reaction_type_brown==\"anaphylaxis\"),\"d_severity_rm\"])\n})\nsums.preds.rm <- do.call(rbind,sums.preds.RM)\n\nsums.preds.RM <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],function(x){\n  table(x,data[which(reaction_type_brown==\"anaphylaxis\"),\"d_severity_rm\"])\n})\nsums.preds.rm <- do.call(rbind,sums.preds.RM)\n\n\nmedian.preds.A4 <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],function(x){\n  sapply(split(data[which(reaction_type_brown==\"anaphylaxis\"),\"ANAscore4\"],x),median)\n})\n\nmedian.preds.a4 <- do.call(rbind,median.preds.A4)\n\niqr.preds.A4 <- lapply(data[which(reaction_type_brown==\"anaphylaxis\"),predictors[c(3:8,10:15,17,18,9,16)]],function(x){\n  sapply(split(data[which(reaction_type_brown==\"anaphylaxis\"),\"ANAscore4\"],x),quantile)\n})\n\niqr.preds.A4 <- lapply(predictors[c(3:8,10:15,17,18,9,16)],function(x){\n  t(iqr.preds.A4[[x]][c(2,4),])\n  })\niqr.preds.a4<-do.call(rbind,iqr.preds.A4)\n\nmain  <- cbind(sums.preds.b,sums.preds.rm,unlist(median.preds.A4),iqr.preds.a4)\n\nset.s <- function(x){\n  matrix(c(x[1,],x[2,],rep(\"\",9),x[3,],x[4,],rep(\"\",9),x[5,],x[6,],rep(\"\",9),x[7,],x[8,],rep(\"\",9),x[9,],x[10,],rep(\"\",9),x[11,],x[12,],rep(\"\",9),x[13,],x[14,],rep(\"\",9),x[15,],x[16,],rep(\"\",9),x[17,],x[18,],rep(\"\",9),x[19,],x[20,],rep(\"\",9),x[21,],x[22,],rep(\"\",9),x[23,],x[24,],rep(\"\",9),x[25,],x[26,],rep(\"\",9),x[27,],x[28,],rep(\"\",9),x[29,],x[30,],x[31,],x[32,],rep(\"\",9),x[33,],x[34,],x[35,],x[36,]),ncol=9,byrow = T)\n}\n# set.s(main)\n```\n\n# Abstract extracted values \n\n```{r}\ntemp.count <- dplyr::select(dplyr::count(dplyr::group_by(data,b_centres_id)),n)\nkinder.klin <- dplyr::count(dplyr::group_by(data,b_centres_id))\nkind <- kinder.klin$b_centres_id[which(kinder.klin$n>0)] %>% \n  grep(pattern = \"kinder\", ignore.case=T) %>% \n  length()\n\ncenter.temp<-length(which(temp.count>0))\ncountry.temp <- dplyr::select(dplyr::count(dplyr::group_by(data,d_centres_country)),n)\ncountry.temp <- length(which(country.temp>0))-1\n```\n\n```{r, prep_table_points}\n# rec.names(C)\n\nrec.names <-  function(x){\n  ##require(car)\n  car::recode(x,\n         \"'q_113_cough_v5'='Cough';\n         'q_113_rhinitis_v5'='Rhinitis';\n         'q_113_change_in_voice_v5'='Voice change';\n         'q_111_conjunctivitis_v5'='Conjunctivitis';\n         'q_111_urticaria'='Urticaria';\n         'q_111_pruritus'='Pruritis';\n         'q_115_dysphonia_v6'='Dysphonia';\n         'q_111_erythema_flush_v5'='Erythema';\n         'q_113_dyspnea'='Dyspnea';\n         'q_113_throat_tightness_v5'='Throat tightness';\n         'q_113_stridor_inspiratory'='Inspiratory stridor';\n         'q_113_wheezing_expiratory_distress_v5'='Expiratory stridor';\n         'q_113_chest_tightness_v5'='Chest tightness';\n         'q_115_cyanosis_pallor_v6'='Cyanosis';\n         'q_112_dysphagia_v5'='Dysphagia';\n         'q_112_abdominal_pain'='Abdominal pain';\n         'q_112_nausea'='Nausea';\n         'q_112_abdominal_distention_v5'='Abdominal distension';\n         'q_112_vomiting'='Vomiting';\n         'q_112_diarrhoea'='Diarrhoea';\n         'q_112_incontinence'='Incontinence';\n         'q_111_angioedema'='Angioedema';\n         'q_114_tachycardia'='Tachycardia';\n         'q_114_palpitations_cardiac_arrythmia_v5'='Cardiac arrythmia';\n         'q_114_hypotension_collapse_v5'='Collapse';\n         'q_114_dizziness'='Dizziness';\n'q_115_tingle_hands_feet_paresthesia_v6'='Paresthesia in hands and feet';\n'q_115_hot_sweat_tremble_v6'='Hot sweat tremble';\n'q_115_sight_disorder_v6'='Sight disorder';\n'q_114_reductions_of_alertness'='Reduced alertness';\n'q_115_dysarthria_v6'='Dysarthria';\n'q_114_chest_pain_angina_v5'='Chest pain, angina';\n'q_114_loss_of_consciousness'='Loss of conciousness';\n'q_113_respiratory_arrest'='Respiratory arrest';\n'q_114_cardiac_arrest'='Cardiac arrest';\n'q_115_agony_v6'='Agony';\n'q_140_fatal'='Fatal reaction';\n\n\")\n}\n\nrequire(knitr)\ntab_points <- kable(\n  data.frame(\n    Symptom=rec.names(As),\n    Points=c(1,1,1,1,1,2,2,2,2,3,3,3,4,5,6,6,7,7,7,8,9,9,10,10,11,11,12,13,14,15,15,16,17,18,19,19,20)\n    )\n  )\n\n```\n\n\n\n```{r calculate_severity}\nsev<-summary(data$severity_brown)\n```\n\n\n```{r table_demographics}\n# selected anaphylaxis cases only this has to be conformant with what is in the diagram \nduplicates <- rep(\"first\",nrow(data))\nduplicates[which(reaction_type_brown==\"anaphylaxis\"&duplicated(data$b_patient_code))] <- \"repeated\"\ndata$duplicates <- duplicates\ndata$duplicates %<>% factor \ndata$duplicates %>% summary\n\ndata.cc <- data[which(reaction_type_brown==\"anaphylaxis\"&!duplicated(data$b_patient_code)),c(\"severity_brown\",\"b_sex\",\"age_group\",\"d_elicitor_group\")]\n\nsums <- sapply(data.cc[which(sapply(data.cc,class)==\"factor\")[-1]],function(x){\n  table(x,data.cc$severity_brown)\n})\n\n# names(sums) <- c(\"Sex\",\"Age group\",\"Elicitor group\")\n# tab1 <- matrix(rep(\"\",76),ncol=4,nrow=19,)\n# tab1[1,3:4] <- colnames(sums[[1]])\n# tab1[2,1] <- names(sums)[1]\n# tab1[3:4,2] <- row.names(sums[[1]])\n# tab1[3:4,3:4] <- sums[[1]]\n# tab1[5,1] <- names(sums)[2]\n# tab1[6:8,2] <- row.names(sums[[2]])\n# tab1[6:8,3:4] <- sums[[2]]\n# tab1[9,1] <- names(sums)[3]\n# tab1[10:19,2] <- row.names(sums[[3]])\n# tab1[10:19,3:4] <- sums[[3]]\n# colnames(tab1)<-c(\"\",\"\",\"mild\",\"severe\")\n#  kable(tab1[2:18,])\n\n\ns.t <- list(count(data[which(reaction_type_brown==\"anaphylaxis\"),],vars=\"b_sex\"),count(data.cc,vars=\"age_group\"),count(data.cc,vars=\"d_elicitor_group\"))\n\n#This table was substituted with the one above it. to show the total number of cases.\n\nnames(sums) <- c(\"Sex\",\"Age group\",\"Elicitor group\")\ntab1 <- matrix(rep(\"\",15*3),ncol=3,nrow=15)\n# tab1[1,3] <- \"Number of cases\"\ntab1[2,1] <- names(sums)[1]\ntab1[3:4,2] <- row.names(sums[[1]])\ntab1[3:4,3] <- s.t[[1]][,2]\ntab1[5,1] <- names(sums)[2]\ntab1[6:8,2] <- c(\"child (< 13 years)\",\n                 \"adult (13-56 years)\",\n                 \"senior (> 56 years)\")#row.names(sums[[2]])\ntab1[6:8,3] <- s.t[[2]][,2]\ntab1[9,1] <- names(sums)[3]\ntab1[10:14,2] <- c(row.names(sums[[3]]))\ntab1[10:14,3] <- s.t[[3]][,2]\ncolnames(tab1)<-c(\"Demographics\",\"\",\"Total number of cases\")\nkable(tab1)\n```\n\n\n```{r plot_age}\nrequire(ggplot2)\np1 <- ggplot(data.c$train,aes(d_age, ..count..,fill=severity_brown ))+\n  geom_density(position = \"fill\")+\n  theme_bw()+\n  # qplot(d_age, ..count.., data=data.c$train, geom=\"density\", fill=severity_brown, position=\"fill\")+\n  theme(legend.position=c(1,0),legend.justification=c(1,0))+\n  geom_segment(aes(x=13,y=0,xend=13,yend=1))+geom_segment(aes(x=57,y=0,xend=57,yend=1))+ggtitle(\"NIAID/FAAM\")+\n  scale_fill_grey()\np1\n\n# Alternative age plot --------------\nd.ages <- data.frame(age=data.c$train$d_age,\n                     b=data.c$train$severity_brown,\n                     rm=data.c.rmr2$train$rmr2)\nd.ages.l <- split(d.ages,d.ages$age)\n\nd.ages.rm<- sapply(d.ages.l,function(x){\n  length(which(x$rm==\"IV\"))/length(x$rm)*100\n})\n\nd.ages.b<- sapply(d.ages.l,function(x){\n  length(which(x$b==\"severe\"))/length(x$b)*100\n})\n\n\nd.ages2 <- data.frame(age=as.numeric(names(d.ages.rm)),rm=d.ages.rm,b=d.ages.b)\n\nd.ages2$roll.rm <- c(NA,NA,NA,zoo::rollmean(d.ages2$rm,k=7),NA,NA,NA)\nd.ages2$roll.b <- c(NA,NA,NA,zoo::rollmean(d.ages2$b,k=7),NA,NA,NA)\n\nage.loess <- ggplot(d.ages2,aes(age,rm))+\n  geom_point(color=\"blue\")+\n  #geom_line(aes(y=roll.rm),color=\"blue\")+\n  stat_smooth(aes(y=b),method = \"loess\",color=\"red\")+\n  geom_point(aes(y=b))+\n  stat_smooth(method = \"loess\",color=\"red\")+\n  ylab(\"Severe reactions [%]\")+\n  theme_bw()\nage.loess\n\nage.roll <- ggplot(d.ages2,aes(age,rm))+\n  geom_point(color=\"blue\")+\n  geom_line(aes(y=roll.rm),color=\"red\",lwd=1)+\n  geom_point(aes(y=b))+\n  geom_line(aes(y=roll.b),color=\"red\",lwd=1)+\n  ylab(\"Severe reactions [%]\")+\n  theme_bw()\nage.roll\n```\n\n\n```{r}\n\n# p2 <-qplot(d_age, ..count.., data=data.c.rmr$train, geom=\"density\", fill=rmr, position=\"fill\")+\n# theme_bw()+\n#   geom_segment(aes(x=13,y=0,xend=13,yend=1))+geom_segment(aes(x=57,y=0,xend=57,yend=1))+ggtitle(\"Ring and Messmer var 1.\")\n\np3 <- ggplot(data[!is.na(data$d_severity_rm),],\n             aes(d_age,\n                 ..count..,\n                 fill=d_severity_rm))+\n  geom_density(position = \"fill\")+\n  theme_bw()+\n  # plot(data$reaction)\n  # qplot(d_age, ..count.., data=data[which(reaction_type_brown==\"anaphylaxis\"),], geom=\"density\", fill=d_severity_rm, position=\"fill\")+\n  # theme(legend.position=c(1,0),legend.justification=c(1,0))+\n  geom_segment(aes(x=13,y=0,xend=13,yend=1))+geom_segment(aes(x=57,y=0,xend=57,yend=1))+ggtitle(\"Ring and Messmer\")+\n  scale_fill_grey()+\n  guides(fill=guide_legend(reverse=F))\n\n# data.c$train$d_severity_rm <- data$d_severity_rm[as.numeric(rownames(data.c$train))]\n# temp.d <- dplyr::select(data.c$train,d_severity_rm,d_age,severity_brown)\n# temp.d$age <- cut(temp.d$d_age,\n#                   breaks = c(0,10,20,30,40,50,60,70,80,90),\n#                   labels = c(\"0-10\",\"10-20\",\"20-30\",\"30-40\",\"40-50\",\"50-60\",\"60-70\",\"70-80\",\"80-90\"))\n#temp.d$d_severity_rm <- factor(temp.d$d_severity_rm, levels=rev(levels(temp.d$d_severity_rm)))\n# txl <-  ggplot(temp.d[!is.na(temp.d$age),],aes(age,fill=d_severity_rm))+\n#   geom_bar(position=\"fill\")+\n#   theme_bw()+\n#   scale_fill_grey()+\n#   ylab(\"Relative frequency\")+\n#   guides(fill=guide_legend(reverse=F),\n#          colour=guide_legend(reverse=F))\n```\n\n```{r}\n# p.age.rm <- ggplot(temp.d,aes(d_severity_rm,d_age))+\n#   geom_boxplot()+\n#   theme_bw()\n# p.age.b <- ggplot(temp.d,aes(severity_brown,d_age))+\n#   geom_boxplot()+\n#   theme_bw()\n```\n\n```{r}\n# p4 <-qplot(d_age, ..count.., data=data[complete.cases(data[,\"q_140_fatal\"]),], geom=\"density\", fill=q_140_fatal, position=\"fill\")+\n# theme_bw()+\n#   geom_segment(aes(x=13,y=0,xend=13,yend=1))+geom_segment(aes(x=57,y=0,xend=57,yend=1))+ggtitle(\"Fatalities\")\n\n# p5   <-qplot(d_age, ..count.., data=data[complete.cases(data[,\"q_115_agony_v6\"]),], geom=\"density\", fill=q_115_agony_v6, position=\"fill\")+\n# theme_bw()+\n#   geom_segment(aes(x=13,y=0,xend=13,yend=1))+geom_segment(aes(x=57,y=0,xend=57,yend=1))+ggtitle(\"Agonizing patients\")\n# cor.test(data$ANAscore4,data$d_age,method = \"spearman\")\n\n# \n# p6<-ggplot(data[which(reaction_type_brown==\"anaphylaxis\"),], aes(d_age, ANAscore4))+\n#   geom_point(position=position_jitter(width=0.1),alpha=1/10)+\n#   theme_bw()+\n#   ggtitle(\"ANAscore\")+\n#   geom_segment(aes(x=13,y=0,xend=13,yend=25))+geom_segment(aes(x=57,y=0,xend=57,yend=25))+\n#   geom_smooth(method=lm,color=\"red\")\n# \n```\n\n```{r model_brown,results='hide'}\npredictors <- c(names(data[,c(11,12,181,183,185,189,\n                              195,197,208,209,211:214,220)]),\n                \"d_elicitor_group\",\n                \"q_160_ever_react\",\"q_425_alcohol\")\n#data.r <- data[which(data$reaction_type_brown==\"anaphylaxis\"),]\n\n### ADD ON!!!\ndata$rm_def <-sapply(data$d_severity_rm,function(x)ifelse(x==\"grade II\"|x==\"grade III\"|x==\"grade IV\",'ANA','no'))\n\n\ndata.r <- data[unique(data$b_patient_code),]\ndata.r <- data.r[data.r$reaction_type_brown==\"anaphylaxis\",]\n# data.r <- data.r[data.r$rm_def==\"ANA\",]\n\ndata.c <- anareg::cc.restrictor(\"severity_brown\",\n                                c(predictors,\"q_410_infect_cur\"),\n                                data.r,\n                                single.set = T)\ndata.constant <- data.c\ndata.constants <- data[rownames(data)%in%rownames(data.constant$train),]\n\nm.b <- glm(data.c$formula,data.c$train,family=binomial)\n# summary(m.b)\n# choosing the best model\nm.b.f  <- stepAIC(m.b)\n\n# enlarging the number of cases to fit into the final model:\n\np.mbf<- plot_odds(m.b.f)\n\n\n### Saving it for the server\n# save(m.b.f, file=\"../Cofactors/models/m.brown.rda\")\n```\n\n```{r brown_model_table}\nsums <- sapply(data.c$train[which(sapply(data.c$train,class)==\"factor\")[-1]],function(x){\n  table(x,data.c$train$severity_brown)\n})\n# s <- sapply(sums,rbind)\n# s1 <- do.call(what = rbind,s)\n# s2<-matrix(c(\"Sex\",\"\",\"Rhinitis\",\"\",\"Asthma\",\"\",\"Atopic dermatitis\",\"\",\"Coardiologic conditions\",\"\",\"Mastocytosis\",\"\",\"Thyroid conditions\",\"\",\"Exercise level\",\"\",\"\",\"\",\"Elevated stress level\",\"\",\"ACE-I\",\"\",\"ASA\",\"\",\"AT2\",\"\",\"Beta-blockers\",\"\",\"Other medication\",\"\",\"Elicitor group\",\"\",\"\",\"\",\"Previous reactions?\",\"\",\"Increased alcohol usage\",\"\",\n# rownames(s1),s1[,1],s1[,2]),ncol=4)\n# colnames(s2) <- c(\"\",\"\",\"mild\",\"severe\")\n# kable(s2)\n### One more time - making a table with percentages \n# Table description: Description of the variables in the databse. \nsev.c<-count(data.c$train$severity_brown)\ns3 <- matrix(c(\"No.\",sev.c[1,2],\"\",sev.c[2,2],\"\",\"\"),ncol=6)\ncolnames(s3)  <- c(\"Variable\",\"Mild anaphylaxis\",\"\",\"Severe anaphylaxis\",\"\",\"p value\") \ns3 <- rbind(s3,c(\"Demographics\",\"\",\"\",\"\",\"\",\"\"))\nage_cal <- by(data.c$train$d_age,data.c$train$severity_brown,mean)\nage_cal.sd <- by(data.c$train$d_age,data.c$train$severity_brown,sd)\nage.p <- t.test(data.c$train$d_age~data.c$train$severity_brown)\n\ncng.p  <- function(x){\n  ifelse(x>0.001,return(x),return(\"<.001\"))\n}\n\ns3 <- rbind(s3,c(\"&nbsp; Age [years (SD)]\",\n                 round(age_cal[[1]],2),\n                 paste0(\"(\",round(age_cal.sd[[1]],2),\")\"),\n                 round(age_cal[[2]],2),\n                 paste0(\"(\",round(age_cal.sd[[2]],2),\")\"),\n                 cng.p(round(age.p$p.value,2))))\n\nper <- function(x,n){\n  paste0(\"(\",percent(prop.table(x,2)[n]),\")\")\n}\nper.2 <- function(x){\n  cng.p(round(summary(x)$p.value,4))\n}\n\ns3 <- rbind(s3,c(\"&nbsp; Female sex\",\n                 sums$b_sex[1],\n                 per(sums$b_sex,1),\n                 sums$b_sex[3],\n                 per(sums$b_sex,3),\n                 per.2(sums$b_sex)))\ns3 <- rbind(s3,c(\"Factors increasing risk for severe anaphylaxis\",\"\",\"\",\"\",\"\",\"\"))\ns3 <- rbind(s3,c(\"&nbsp; Asthma\",\n                 sums$q_410_asthma_cur[2],\n                 per(sums$q_410_asthma_cur,2),\n                 sums$q_410_asthma_cur[4],\n                 per(sums$q_410_asthma_cur,4),\n                 per.2(sums$q_410_asthma_cur)))\ns3 <- rbind(s3,c(\"&nbsp; Atopic Dermatitis\",\n                 sums$q_410_ad_cur[2],\n                 per(sums$q_410_ad_cur,2),\n                 sums$q_410_ad_cur[4],\n                 per(sums$q_410_ad_cur,4),\n                 per.2(sums$q_410_ad_cur)))\ns3 <- rbind(s3,c(\"&nbsp; Mastocytosis\",\n                 sums$q_410_masto_cur[2],\n                 per(sums$q_410_masto_cur,2),\n                 sums$q_410_masto_cur[4],\n                 per(sums$q_410_masto_cur,4),\n                 per.2(sums$q_410_masto_cur)))\ns3 <- rbind(s3,c(\"&nbsp; Thyroid conditions\",\n                 sums$q_410_thyroid_cur[2],\n                 per(sums$q_410_thyroid_cur,2),\n                 sums$q_410_thyroid_cur[4],\n                 per(sums$q_410_thyroid_cur,4),\n                 per.2(sums$q_410_thyroid_cur)))\ns3 <- rbind(s3,c(\"&nbsp; Psychological stress\",\n                 sums$q_422_stress[2],\n                 per(sums$q_422_stress,2),\n                 sums$q_422_stress[4],\n                 per(sums$q_422_stress,4),\n                 per.2(sums$q_422_stress)))\ns3 <- rbind(s3,c(\"&nbsp; Alcohol exposition\",\n                 sums$q_425_alcohol[2],\n                 per(sums$q_425_alcohol,2),\n                 sums$q_425_alcohol[4],\n                 per(sums$q_425_alcohol,4),\n                 per.2(sums$q_425_alcohol)))\ns3 <- rbind(s3,c(\"Level of physical activity\",\"\",\"\",\"\",\"\",\"\"))\nex.p <-sapply(round(pairwise.prop.test(sums$q_421_exercise)$p.value,4),cng.p)\ns3 <- rbind(s3,c(\"&nbsp; Low\",\n                 sums$q_421_exercise[1],\n                 per(sums$q_421_exercise,1),\n                 sums$q_421_exercise[5],\n                 per(sums$q_421_exercise,5),\n                 \"Reference\"))\ns3 <- rbind(s3,c(\"&nbsp; Mild\",\n                 sums$q_421_exercise[2],\n                 per(sums$q_421_exercise,2),\n                 sums$q_421_exercise[6],\n                 per(sums$q_421_exercise,6),\n                 ex.p[1]))\ns3 <- rbind(s3,c(\"&nbsp; Moderate\",\n                 sums$q_421_exercise[3],\n                 per(sums$q_421_exercise,3),\n                 sums$q_421_exercise[7],\n                 per(sums$q_421_exercise,7),\n                 ex.p[2]))\ns3 <- rbind(s3,c(\"&nbsp; Vigorous\",\n                 sums$q_421_exercise[4],\n                 per(sums$q_421_exercise,4),\n                 sums$q_421_exercise[8],\n                 per(sums$q_421_exercise,8),\n                 ex.p[3]))\ns3 <- rbind(s3,c(\"Elicitors\",\"\",\"\",\"\",\"\",\"\"))\n## Possible ERROR! DOUBLE CHEK!!\nel.p <- sapply(round(pairwise.prop.test(sums$d_elicitor_group[1:4,])$p.value,4),cng.p)\ns3 <- rbind(s3,c(\"&nbsp; Other\",\n                 sums$d_elicitor_group[1],\n                 per(sums$d_elicitor_group,1),\n                 sums$d_elicitor_group[5],\n                 per(sums$d_elicitor_group,5),\n                 \"Reference\"))\ns3 <- rbind(s3,c(\"&nbsp; Food\",\n                 sums$d_elicitor_group[2],\n                 per(sums$d_elicitor_group,2),\n                 sums$d_elicitor_group[6],\n                 per(sums$d_elicitor_group,6),\n                 el.p[1]))\ns3 <- rbind(s3,c(\"&nbsp; Drugs\",\n                 sums$d_elicitor_group[3],\n                 per(sums$d_elicitor_group,3),\n                 sums$d_elicitor_group[7],\n                 per(sums$d_elicitor_group,7),\n                 el.p[2]))\ns3 <- rbind(s3,c(\"&nbsp; Insects\",\n                 sums$d_elicitor_group[4],\n                 per(sums$d_elicitor_group,4),\n                 sums$d_elicitor_group[8],\n                 per(sums$d_elicitor_group,8),\n                 el.p[3]))\n\nbrown.model.tab <- s3\ntab.Brown <- kable(s3)\n\n# m.b.f.more <- glm(m.b.f$formula,data = data,family = binomial)\n# plot_odds(m.b.f.more)\n```\n\n```{r table_preds}\ntab.preds <- matrix(rep(\"\",12*(length(unlist(sums.preds))+1)),ncol=12)\ncolnames(tab.preds) <- c(\"Predictor\",\"\",\"NIAID/FAAM\",\"\",\"R&M\",\"\",\"\",\"\",\"ANAscore\",\"\",\"\",\"Total\")\ntab.preds[2:53,12] <- unlist(sums.preds)\ntab.preds[2:52,3:11] <- set.s(main)\nx <- rownames(main)\nx <- c(x[1],x[2],rep(\"missing\",1),x[3],x[4],rep(\"missing\",1),x[5],x[6],rep(\"missing\",1),x[7],x[8],rep(\"missing\",1),x[9],x[10],rep(\"missing\",1),x[11],x[12],rep(\"missing\",1),x[13],x[14],rep(\"missing\",1),x[15],x[16],rep(\"missing\",1),x[17],x[18],rep(\"missing\",1),x[19],x[20],rep(\"missing\",1),x[21],x[22],rep(\"missing\",1),x[23],x[24],rep(\"missing\",1),x[25],x[26],rep(\"missing\",1),x[27],x[28],rep(\"missing\",1),x[29:32],\"missing\",x[33:36],\"missing\")\ntab.preds[2:53,2]<-x\ntab.preds[1,] <- c(\"\",\"\",\"Non-severe\",\"Severe\",\"Grade I\",\"Grade II\",\"Grade III\",\"Grade IV\",\"Median\",\"Lower-Q\",\"Upper-Q\",\"\")\ntab.preds[,1] <- c(\"\",\"Concomitant rhinitis\",\"\",\"\",\"Concomitant asthma\",\"\",\"\",\"Concomitant AD\",\"\",\"\",\"Concomitant cardiologic conditions\",\"\",\"\",\"Concomitant mastocytosis\",\"\",\"\",\"Concomitant thyroid conditions\",\"\",\"\",\"Exposition to psychological stess\",\"\",\"\",\"Intake of ACE-I\",\"\",\"\",\"Intake of ASA\",\"\",\"\",\"Intake of AT-2 inh.\",\"\",\"\",\"Intake of beta-blockers\",\"\",\"\",\"Intake of other drugs\",\"\",\"\",\"Previous anaphylaxis\",\"\",\"\",\"Increased alcohol consumption\",\"\",\"\",\"Physical exercise level\",\"\",\"\",\"\",\"\",\"Elicitor group\",\"\",\"\",\"\",\"\")\n\n# t.sex <- table(data$b_sex[reaction_type_brown==\"anaphylaxis\"],data$severity_brown[reaction_type_brown==\"anaphylaxis\"])\n# tab.preds[54,] <- c(\"Sex\",\"female\",t[1,1],t[1,2],\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\")\n```\n\n```{r table_demographics_with_constant_numbers}\n# selected anaphylaxis cases only this has to be conformant with what is in the diagram \nfinal.cases <- row.names(data.constant$train)\ndata.cc <- data[rownames(data)%in%final.cases,c(\"severity_brown\",\"b_sex\",\"age_group\",\"d_elicitor_group\")]\n\nsums <- sapply(data.cc[which(sapply(data.cc,class)==\"factor\")[-1]],function(x){\n  table(x,data.cc$severity_brown)\n})\n\n\ns.t <- list(count(data.cc,vars=\"b_sex\"),count(data.cc,vars=\"age_group\"),count(data.cc,vars=\"d_elicitor_group\"))\n\n#This table was substituted with the one above it. to show the total number of cases.\n\nnames(sums) <- c(\"Sex\",\"Age group\",\"Elicitor group\")\ntab1 <- matrix(rep(\"\",14*3),ncol=3,nrow=14)\n# tab1[1,3] <- \"Number of cases\"\ntab1[2,1] <- names(sums)[1]\ntab1[3:4,2] <- row.names(sums[[1]])\ntab1[3:4,3] <- s.t[[1]][,2]\ntab1[5,1] <- names(sums)[2]\n# tab1[6:8,2] <- row.names(sums[[2]])\ntab1[6:8,2] <- c(\"child (< 13 years)\",\n                 \"adult (13-56 years)\",\n                 \"senior (> 56 years)\")#row.names(sums[[2]])\ntab1[6:8,3] <- s.t[[2]][,2]\ntab1[9,1] <- names(sums)[3]\ntab1[10:13,2] <- row.names(sums[[3]])\ntab1[10:13,3] <- s.t[[3]][,2]\ncolnames(tab1)<-c(\"Demographics\",\"\",\"Total number of cases\")\n```\n\n\n```{r model_RM,results='hide'}\n### Second version of Ring and Messmer \n#predictors <- c(names(data[,c(11,12,181,183,185,189,195,197,208,209,211:214,220)]),\"d_elicitor_group\",\"q_160_ever_react\",\"q_425_alcohol\")\n#data.r <- data[which(reaction_type_brown==\"anaphylaxis\"),]\n\ndata.c <- cc.restrictor(\"rmr\",\n                        c(predictors),\n                        data.r,\n                        single.set = T)\nm.rmr3 <- glm(data.c$formula,data.c$train,family=binomial)\nm.rmr3.aic<- stepAIC(m.rmr3)\np.rmr3 <- plot_odds(m.rmr3.aic)\n\n# save(m.rmr3.aic, file=\"../Cofactors/models/m.rmr2.rda\")\n\n\n# m.rmr3.more <- glm(m.rmr3.aic$formula,data,family=binomial)\n# plot_odds(m.rmr3.more)\n# require(caret)\n# require(randomForest)\n# p.rmr3.vi <- varImp(m.rmr3.aic)\n# plot(p.rmr3.vi)\nsums <- sapply(data.c$train[which(sapply(data.c$train,class)==\"factor\")[-1]],function(x){\n  table(x,data.c$train$rmr2)\n})\n\nsev.c<-count(data.c$train$rmr2)\ns3 <- matrix(c(\"No.\",sev.c[1,2],\"\",sev.c[2,2],\"\",\"\"),ncol=6)\ncolnames(s3)  <- c(\"Variable\",\"Grades I-III\",\"(%)\",\"Grade IV\",\"(%)\",\"p value\") \ns3 <- rbind(s3,c(\"Demographics\",\"\",\"\",\"\",\"\",\"\"))\nage_cal <- by(data.c$train$d_age,data.c$train$rmr2,mean)\nage_cal.sd <- by(data.c$train$d_age,data.c$train$rmr2,sd)\nage.p <- t.test(data.c$train$d_age~data.c$train$rmr2)\n\ncng.p  <- function(x){\n  ifelse(x>0.0001,return(round(as.numeric(x),4)),return(\"<.0001\"))\n}\n\ns3 <- rbind(s3,c(\"&nbsp; Age\",round(age_cal[[1]],2),round(age_cal.sd[[1]],2),round(age_cal[[2]],2),round(age_cal.sd[[2]],2),cng.p(round(age.p$p.value,2))))\n\nper <- function(x,n){\n  paste0(\"(\",percent(prop.table(x,2)[n]),\")\")\n}\nper.2 <- function(x){\n  cng.p(round(summary(x)$p.value,4))\n}\n\ns3 <- rbind(s3,c(\"&nbsp; Female sex\", \n                 sums$b_sex[1], per(sums$b_sex,1),\n                 sums$b_sex[3], per(sums$b_sex,3),\n                 per.2(sums$b_sex)))\ns3 <- rbind(s3,c(\"Factors increasing risk for severe anaphylaxis\",\"\",\"\",\"\",\"\",\"\"))\ns3 <- rbind(s3,c(\"&nbsp; Asthma\", \n                 sums$q_410_asthma_cur[2], per(sums$q_410_asthma_cur,2),\n                 sums$q_410_asthma_cur[4], per(sums$q_410_asthma_cur,4),\n                 per.2(sums$q_410_asthma_cur)))\ns3 <- rbind(s3,c(\"&nbsp; Beta blocker\",\n                 sums$q_423_beta[2], per(sums$q_423_beta,2),\n                 sums$q_423_beta[4], per(sums$q_423_beta,4),\n                 per.2(sums$q_423_beta)))\ns3 <- rbind(s3,c(\"&nbsp; Mastocytosis\", \n                 sums$q_410_masto_cur[2], per(sums$q_410_masto_cur,2),\n                 sums$q_410_masto_cur[4], per(sums$q_410_masto_cur,4),\n                 per.2(sums$q_410_masto_cur)))\ns3 <- rbind(s3,c(\"&nbsp; AT II antagonist\",\n                 sums$q_423_at2[2], per(sums$q_423_at2,2),\n                 sums$q_423_at2[4], per(sums$q_423_at2,4),\n                 per.2(sums$q_423_at2)))\ns3 <- rbind(s3,c(\"&nbsp; Psychological stress\",\n                 sums$q_422_stress[2], per(sums$q_422_stress,2),\n                 sums$q_422_stress[4], per(sums$q_422_stress,4),\n                 per.2(sums$q_422_stress)))\ns3 <- rbind(s3,c(\"Elicitors\",\"\",\"\",\"\",\"\",\"\"))\n## Possible ERROR! DOUBLE CHEK!!\nel.p <- sapply(round(pairwise.prop.test(sums$d_elicitor_group[1:4,])$p.value,\n                     4),\n               cng.p)[1:3]\ns3 <- rbind(s3,c(\"&nbsp; Other\",\n                 sums$d_elicitor_group[1], per(sums$d_elicitor_group,1),\n                 sums$d_elicitor_group[5], per(sums$d_elicitor_group,5),\n                 \"Reference\"))\ns3 <- rbind(s3,c(\"&nbsp; Food\",\n                 sums$d_elicitor_group[2], per(sums$d_elicitor_group,2),\n                 sums$d_elicitor_group[6], per(sums$d_elicitor_group,6),\n                 el.p[1]))\ns3 <- rbind(s3,c(\"&nbsp; Drugs\",\n                 sums$d_elicitor_group[3], per(sums$d_elicitor_group,3),\n                 sums$d_elicitor_group[7], per(sums$d_elicitor_group,7),\n                 el.p[2]))\ns3 <- rbind(s3,c(\"&nbsp; Insects\",\n                 sums$d_elicitor_group[4], per(sums$d_elicitor_group,4),\n                 sums$d_elicitor_group[8], per(sums$d_elicitor_group,8),\n                 el.p[3]))\n\n\ntab.rm <- kable(s3)\n\n```\n\n# Example of a closely corellated variable - month of reaction and elicitor type\n\n```{r}\ntable(data$MOR,data$d_elicitor_group)\nggplot(data[data$d_elicitor_group==\"insects\"&!is.na(data$MOR),],\n       aes(MOR))+\n  geom_histogram(stat=\"count\")\n\nggplot(data[data$d_elicitor_group==\"food\"&!is.na(data$MOR),],\n       aes(MOR))+\n  geom_histogram(stat=\"count\")\n\nggplot(data[data$d_elicitor_group==\"drug\"&!is.na(data$MOR),],\n       aes(MOR))+\n  geom_histogram(stat=\"count\")\n\nggplot(data[!is.na(data$MOR),],\n       aes(MOR,fill=d_elicitor_group))+\n  geom_bar(position = position_stack(reverse=T))+\n  theme_classic()+\n  theme(legend.position = c(0.1,1),\n        legend.justification = c(0,1))+\n  labs(fill=\"Elicitor\",x=\"Month of the year\",y=\"Number of ANA cases in each month\")\n```\n\n# Description of cases not meeting ana-definition\n\n```{r}\nreaction_type_brown\n```\n",
    "created" : 1503548540566.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3947231314",
    "id" : "A81FBB32",
    "lastKnownWriteTime" : 1498247656,
    "last_content_update" : 1498247656,
    "path" : "~/Documents/anaphylaxis/pure_statistics.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}